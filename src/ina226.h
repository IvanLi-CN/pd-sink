#ifndef INA226_H
#define INA226_H

#include "ch32v003fun.h"

u8 ina226_init(void);
u8 ina226_read_current(float *current);
u8 ina226_read_power(float *power);
u8 ina226_shunt_voltage(float *voltage);
u8 ina226_read_voltage(float *voltage);

#define INA226_REGISTER_CONFIG 0x00
#define INA226_REGISTER_SHUNT_VOLTAGE 0x01
#define INA226_REGISTER_BUS_VOLTAGE 0x02
#define INA226_REGISTER_POWER 0x03
#define INA226_REGISTER_CURRENT 0x04
#define INA226_REGISTER_CALIBRATION 0x05
#define INA226_REGISTER_MASK_ENABLE 0x06
#define INA226_REGISTER_ALERT_LIMITS 0x07
#define INA226_REGISTER_MANUFACTURER_ID 0xFE
#define INA226_REGISTER_DIE_ID 0xFF

typedef enum {
  INA226_AVG_1 = 0b000,  // default
  INA226_AVG_4 = 0b001,
  INA226_AVG_16 = 0b010,
  INA226_AVG_64 = 0b011,
  INA226_AVG_128 = 0b100,
  INA226_AVG_256 = 0b101,
  INA226_AVG_512 = 0b110,
  INA226_AVG_1024 = 0b111
} ina226_avg_t;

typedef enum {
  INA226_VBUSCT_140us = 0b000,
  INA226_VBUSCT_204us = 0b001,
  INA226_VBUSCT_332us = 0b010,
  INA226_VBUSCT_588us = 0b011,
  INA226_VBUSCT_1100us = 0b100,  // default
  INA226_VBUSCT_2116us = 0b101,
  INA226_VBUSCT_4156us = 0b110,
  INA226_VBUSCT_8246us = 0b111
} ina226_vbusct_t;

typedef enum {
  INA226_VSHUNTCT_140us = 0b000,
  INA226_VSHUNTCT_204us = 0b001,
  INA226_VSHUNTCT_332us = 0b010,
  INA226_VSHUNTCT_588us = 0b011,
  INA226_VSHUNTCT_1100us = 0b100,  // default
  INA226_VSHUNTCT_2116us = 0b101,
  INA226_VSHUNTCT_4156us = 0b110,
  INA226_VSHUNTCT_8246us = 0b111
} ina226_vshuntct_t;

typedef enum {
  INA226_MODE_POWER_DOWN = 0b000,
  INA226_MODE_SHUNT_TRIG = 0b001,
  INA226_MODE_BUS_TRIG = 0b010,
  INA226_MODE_SHUNT_AND_BUS_TRIG = 0b011,
  INA226_MODE_POWER_DOWN2 = 0b100,
  INA226_MODE_SHUNT_CONTINUOUS = 0b101,
  INA226_MODE_BUS_CONTINUOUS = 0b110,
  INA226_MODE_SHUNT_AND_BUS_CONTINUOUS = 0b111,  // default
} ina226_mode_t;

/*
        config
*/

#define INA226_I2C_ADDR 0x40
#define INA226_MODE INA226_MODE_SHUNT_AND_BUS_CONTINUOUS
#define INA226_AVG INA226_AVG_128
#define INA226_VSHUNTCT INA226_VSHUNTCT_2116us
#define INA226_VBUSCT INA226_VBUSCT_2116us

#define INA226_SHUNT_RESISTOR_MILLI_OHM 10
#define INA226_BUS_MAX_CURRENT_AMPERE 6

#define INA226_CONFIG                                                \
  (u8)(INA226_AVG << 9 | INA226_VBUSCT << 6 | INA226_VSHUNTCT << 3 | \
       INA226_MODE)
#endif
